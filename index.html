<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ảnh nội bộ</title>

  <style>
    body {
      margin: 0;
      background: #ffffff;
      font-family: monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: #3a86ff;
    }

    #container {
      width: 70%;
      height: 85%;
      border: 3px solid #3a86ff;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #upload-area {
      font-size: 80px;
      color: #3a86ff;
      cursor: pointer;
      user-select: none;
    }

    #download-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 40px;
      color: #3a86ff;
      user-select: none;
    }

    #preview {
      max-width: 100%;
      max-height: 100%;
      display: none;
    }
  </style>
</head>
<body>

<div id="container">
  <div id="download-btn">⬇️</div>

  <input type="file" id="file-input" accept="image/*" style="display:none">

  <img id="preview">

  <div id="upload-area">+</div>
</div>

<script>
  /* --- CHẶN TRUY CẬP TRỰC TIẾP --- */
  const requiredRef = "https://prinhix.github.io/ktramaso/";

  if (document.referrer !== requiredRef) {
    document.body.innerHTML =
      "<h1 style='color:red;text-align:center;margin-top:20%;'>Không thể truy cập trang web trực tiếp</h1>";
    throw new Error("Blocked direct access");
  }


  /* --- LẤY ELEMENT --- */
  const upload = document.getElementById("upload-area");
  const input = document.getElementById("file-input");
  const preview = document.getElementById("preview");
  const downloadBtn = document.getElementById("download-btn");

  let uploaded = false;


  /* --- KHÔI PHỤC ẢNH ĐÃ LƯU --- */
  const savedImage = localStorage.getItem("savedImage");

  if (savedImage) {
    preview.src = savedImage;
    preview.style.display = "block";
    upload.style.display = "none";
    uploaded = true;
  }


  /* --- UPLOAD ẢNH LẦN ĐẦU --- */
  upload.onclick = () => {
    if (!uploaded) input.click();
  };

  input.onchange = () => {
    const file = input.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      alert("Dung lượng file phải < 5MB");
      return;
    }

    const reader = new FileReader();

    reader.onload = () => {
      const base64 = reader.result;

      localStorage.setItem("savedImage", base64);

      preview.src = base64;
      preview.style.display = "block";
      upload.style.display = "none";
      uploaded = true;
    };

    reader.readAsDataURL(file);
  };


  /* --- TẢI XUỐNG ẢNH --- */
  downloadBtn.onclick = () => {
    if (!uploaded) return;

    const link = document.createElement("a");
    link.href = preview.src;
    link.download = "image.png";
    link.click();
  };
</script>

</body>
</html>
